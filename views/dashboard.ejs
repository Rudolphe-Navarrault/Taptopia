<!-- Conteneur de notifications -->
<div class="notifications-container"></div>

<!-- Sidebar -->
<div class="sidebar">
  <div class="sidebar-icons">
    <button class="sidebar-icon" data-menu="upgrades">
      <i class="fas fa-arrow-up"></i>
    </button>
    <button class="sidebar-icon" data-menu="achievements">
      <i class="fas fa-trophy"></i>
    </button>
    <button class="sidebar-icon" data-menu="settings">
      <i class="fas fa-cog"></i>
    </button>
  </div>

  <div class="sidebar-menu">
    <!-- Menu des améliorations -->
    <div class="menu-content" id="upgrades-menu">
      <h3 data-translate="upgrades">Améliorations</h3>
      <div class="upgrades-grid">
        <div class="upgrade-card">
          <h4 data-translate="clickPower">Puissance de clic</h4>
          <p>
            <span data-translate="level">Niveau :</span>
            <span id="click-power-level">1</span>
          </p>
          <p>
            <span data-translate="cost">Coût :</span>
            <span id="click-power-cost">10</span>
          </p>
          <button
            class="upgrade-button"
            data-upgrade="clickPower"
            data-translate="buy"
          >
            Acheter
          </button>
        </div>
        <div class="upgrade-card">
          <h4 data-translate="autoClicker">Auto-cliqueur</h4>
          <p>
            <span data-translate="level">Niveau :</span>
            <span id="auto-clicker-level">0</span>
          </p>
          <p>
            <span data-translate="cost">Coût :</span>
            <span id="auto-clicker-cost">50</span>
          </p>
          <button
            class="upgrade-button"
            data-upgrade="autoClicker"
            data-translate="buy"
          >
            Acheter
          </button>
        </div>
      </div>
    </div>

    <!-- Menu des succès -->
    <div class="menu-content" id="achievements-menu">
      <h3 data-translate="achievements">Succès</h3>
      <p data-translate="comingSoon">Bientôt disponible...</p>
    </div>

    <!-- Menu des paramètres -->
    <div class="menu-content" id="settings-menu">
      <h3 data-translate="settings">Paramètres</h3>
      <div class="settings-dropdown">
        <div class="settings-section">
          <div class="settings-item">
            <label for="language-select" data-translate="language"
              >Langue</label
            >
            <select
              id="language-select"
              class="settings-select"
              style="
                appearance: none;
                background-image: url('data:image/svg+xml;utf8,<svg fill=\'%23333\' height=\'24\' viewBox=\'0 0 24 24\' width=\'24\' xmlns=\'http://www.w3.org/2000/svg\'><path d=\'M7 10l5 5 5-5z\'/></svg>');
                background-repeat: no-repeat;
                background-position: right 8px center;
                padding-right: 30px;
              "
            >
              <option value="fr">Français</option>
              <option value="en">English</option>
            </select>
          </div>

          <div class="settings-item">
            <label for="theme-select" data-translate="theme">Thème</label>
            <select
              id="theme-select"
              class="settings-select"
              style="
                appearance: none;
                background-image: url('data:image/svg+xml;utf8,<svg fill=\'%23333\' height=\'24\' viewBox=\'0 0 24 24\' width=\'24\' xmlns=\'http://www.w3.org/2000/svg\'><path d=\'M7 10l5 5 5-5z\'/></svg>');
                background-repeat: no-repeat;
                background-position: right 8px center;
                padding-right: 30px;
              "
            >
              <option value="light" data-translate="lightTheme">Clair</option>
              <option value="dark" data-translate="darkTheme">Sombre</option>
            </select>
          </div>

          <div class="settings-item">
            <label data-translate="autoSave">Sauvegarde automatique</label>
            <div class="settings-value-container">
              <select
                id="auto-save-select"
                class="settings-select"
                style="
                  appearance: none;
                  background-image: url('data:image/svg+xml;utf8,<svg fill=\'%23333\' height=\'24\' viewBox=\'0 0 24 24\' width=\'24\' xmlns=\'http://www.w3.org/2000/svg\'><path d=\'M7 10l5 5 5-5z\'/></svg>');
                  background-repeat: no-repeat;
                  background-position: right 8px center;
                  padding-right: 30px;
                "
              >
                <option value="0" data-translate="autoSaveDisabled">
                  Désactivée
                </option>
                <option value="5" data-translate="autoSave5Sec">
                  Toutes les 5 secondes
                </option>
                <option value="10" data-translate="autoSave10Sec">
                  Toutes les 10 secondes
                </option>
                <option value="15" data-translate="autoSave15Sec">
                  Toutes les 15 secondes
                </option>
                <option value="30" data-translate="autoSave30Sec">
                  Toutes les 30 secondes
                </option>
                <option value="60" data-translate="autoSave1Min">
                  Toutes les minutes
                </option>
                <option value="300" data-translate="autoSave5Min">
                  Toutes les 5 minutes
                </option>
                <option value="900" data-translate="autoSave15Min">
                  Toutes les 15 minutes
                </option>
                <option value="1800" data-translate="autoSave30Min">
                  Toutes les 30 minutes
                </option>
                <option value="3600" data-translate="autoSave1Hour">
                  Toutes les heures
                </option>
              </select>
            </div>
            <span id="auto-save-timer"></span>
          </div>
        </div>

        <div class="settings-section">
          <div class="settings-item notifications-item">
            <label for="notifications-toggle" data-translate="notifications"
              >Notifications</label
            >
            <label class="switch">
              <input type="checkbox" id="notifications-toggle" />
              <span class="slider round"></span>
            </label>
          </div>
        </div>

        <div
          class="settings-buttons"
          style="
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 20px;
          "
        >
          <button
            id="save-settings"
            class="btn btn-primary"
            data-translate="save"
            style="
              flex: 1;
              width: 150px;
              height: 40px;
              font-size: 14px;
              font-weight: 500;
              line-height: 40px;
              padding: 0;
              margin: 0;
              border-radius: 4px;
            "
          >
            Sauvegarder
          </button>
          <button
            id="cancel-settings"
            class="btn btn-danger"
            style="
              flex: 1;
              width: 150px;
              height: 40px;
              font-size: 14px;
              font-weight: 500;
              line-height: 40px;
              padding: 0;
              margin: 0;
              border-radius: 4px;
              background-color: #dc3545;
              border-color: #dc3545;
              color: white;
              opacity: 0.5;
              cursor: not-allowed;
            "
          >
            Annuler
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Contenu principal -->
<div class="main-content">
  <div class="game-stats">
    <div class="stats-grid">
      <div class="stat-card">
        <h3 data-translate="coins">Pièces</h3>
        <p id="coins">0</p>
      </div>
      <div class="stat-card">
        <h3 data-translate="coinsPerClick">Pièces par clic</h3>
        <p id="coins-per-click">1</p>
      </div>
      <div class="stat-card">
        <h3 data-translate="coinsPerSecond">Pièces par seconde</h3>
        <p id="coins-per-second">0</p>
      </div>
    </div>
  </div>

  <div class="game-area">
    <div class="click-area">
      <button id="click-button">
        <i class="fas fa-coins"></i>
        <span data-translate="clickMe">Cliquez-moi!</span>
      </button>
    </div>
  </div>

  <!-- Bouton de sauvegarde -->
  <div class="save-container">
    <button id="save-game" class="btn-primary" data-translate="saveGame">
      <i class="fas fa-save"></i> Sauvegarder
    </button>
    <span id="last-save" class="last-save-text" data-translate="lastSave"
      >Dernière sauvegarde: Jamais</span
    >
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/js/all.min.js"></script>

<!-- Translations -->
<script type="module" src="/js/translations/fr.js"></script>
<script type="module" src="/js/translations/en.js"></script>
<script type="module" src="/js/translations/index.js"></script>

<!-- Main script -->
<script src="/js/main.js"></script>

<script>
  // Initialisation du menu au chargement
  document.addEventListener("DOMContentLoaded", function () {
    const sidebarMenu = document.querySelector(".sidebar-menu");
    const mainContent = document.querySelector(".main-content");
    const nav = document.querySelector("nav");
    const footer = document.querySelector("footer");
    let menuTimeout;
    let originalSettings = null;
    let currentSettings = null;
    const cancelButton = document.getElementById("cancel-settings");

    // Cacher tous les menus au démarrage
    document.querySelectorAll(".menu-content").forEach((menu) => {
      menu.style.display = "none";
    });

    // Gestion du survol des icônes
    document.querySelectorAll(".sidebar-icon").forEach((icon) => {
      const menuId = icon.dataset.menu + "-menu";
      const menu = document.getElementById(menuId);

      icon.addEventListener("mouseenter", () => {
        clearTimeout(menuTimeout);
        // Cacher tous les menus
        document.querySelectorAll(".menu-content").forEach((m) => {
          m.style.display = "none";
        });
        // Afficher le menu correspondant
        menu.style.display = "block";
        sidebarMenu.classList.add("active");
        mainContent.classList.add("menu-open");
        nav.classList.add("menu-open");
        footer.classList.add("menu-open");
      });

      icon.addEventListener("mouseleave", () => {
        menuTimeout = setTimeout(() => {
          sidebarMenu.classList.remove("active");
          mainContent.classList.remove("menu-open");
          nav.classList.remove("menu-open");
          footer.classList.remove("menu-open");
        }, 100);
      });
    });

    // Gestion de la sortie du menu
    sidebarMenu.addEventListener("mouseleave", () => {
      menuTimeout = setTimeout(() => {
        sidebarMenu.classList.remove("active");
        mainContent.classList.remove("menu-open");
        nav.classList.remove("menu-open");
        footer.classList.remove("menu-open");
      }, 100);
    });

    // Gestion de l'entrée dans le menu
    sidebarMenu.addEventListener("mouseenter", () => {
      clearTimeout(menuTimeout);
    });

    // Afficher le menu des améliorations par défaut
    const upgradesMenu = document.getElementById("upgrades-menu");
    if (upgradesMenu) {
      upgradesMenu.style.display = "block";
    }

    // Fonction pour vérifier si les paramètres ont été modifiés
    const hasSettingsChanged = () => {
      if (!originalSettings || !currentSettings) return false;
      return (
        JSON.stringify(originalSettings) !== JSON.stringify(currentSettings)
      );
    };

    // Fonction pour mettre à jour l'état du bouton Annuler
    const updateCancelButton = () => {
      if (hasSettingsChanged()) {
        cancelButton.style.opacity = "1";
        cancelButton.style.cursor = "pointer";
      } else {
        cancelButton.style.opacity = "0.5";
        cancelButton.style.cursor = "not-allowed";
      }
    };

    // Charger les paramètres actuels
    const loadSettings = async () => {
      try {
        const response = await fetch("/api/settings");
        if (response.ok) {
          originalSettings = await response.json();
          currentSettings = { ...originalSettings };
          updateCancelButton();
        }
      } catch (error) {
        console.error("Erreur lors du chargement des paramètres:", error);
      }
    };

    // Fonction pour appliquer les paramètres
    const applySettings = (settings) => {
      document.documentElement.lang = settings.language;
      document.body.className = settings.theme;

      // Appliquer le thème à tous les éléments nécessaires
      const elements = document.querySelectorAll(
        ".sidebar, .sidebar-menu, .menu-content, .settings-dropdown, .settings-section, .settings-item, .settings-select, .stat-card, .game-area, .click-area, .save-container"
      );
      elements.forEach((element) => {
        element.className =
          element.className.replace(/light|dark/g, "") + " " + settings.theme;
      });
    };

    // Gérer les changements de paramètres
    document
      .getElementById("language-select")
      .addEventListener("change", () => {
        currentSettings.language =
          document.getElementById("language-select").value;
        applySettings(currentSettings);
        updateCancelButton();
      });

    document.getElementById("theme-select").addEventListener("change", () => {
      currentSettings.theme = document.getElementById("theme-select").value;
      applySettings(currentSettings);
      updateCancelButton();
    });

    document
      .getElementById("notifications-toggle")
      .addEventListener("change", () => {
        currentSettings.notifications = document.getElementById(
          "notifications-toggle"
        ).checked;
        updateCancelButton();
      });

    document
      .getElementById("auto-save-select")
      .addEventListener("change", () => {
        currentSettings.autoSave =
          document.getElementById("auto-save-select").value;
        updateCancelButton();
      });

    // Gérer le clic sur le bouton Annuler
    cancelButton.addEventListener("click", () => {
      if (hasSettingsChanged()) {
        currentSettings = { ...originalSettings };
        document.getElementById("language-select").value =
          originalSettings.language;
        document.getElementById("theme-select").value = originalSettings.theme;
        document.getElementById("notifications-toggle").checked =
          originalSettings.notifications;
        document.getElementById("auto-save-select").value =
          originalSettings.autoSave;
        applySettings(originalSettings);
        updateCancelButton();
      }
    });

    // Charger les paramètres au démarrage
    loadSettings().then(() => {
      applySettings(originalSettings);
    });
  });
</script>
